!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).IDV={})}(this,function(e){"use strict";const t={INVALID_API_KEY:"INVALID_API_KEY",NOT_INITIALIZED:"NOT_INITIALIZED",ALREADY_OPEN:"ALREADY_OPEN",BROWSER_NOT_SUPPORTED:"BROWSER_NOT_SUPPORTED",CAMERA_PERMISSION_DENIED:"CAMERA_PERMISSION_DENIED",CAMERA_NOT_FOUND:"CAMERA_NOT_FOUND",VERIFICATION_FAILED:"VERIFICATION_FAILED",DOCUMENT_UNREADABLE:"DOCUMENT_UNREADABLE",FACE_NOT_DETECTED:"FACE_NOT_DETECTED",NETWORK_ERROR:"NETWORK_ERROR",TIMEOUT:"TIMEOUT",SESSION_EXPIRED:"SESSION_EXPIRED"};class s{constructor(e,t=!1){this.callbacks=new Map,this.processedNonces=new Set,this.allowedOrigins=e,this.debug=t,this.boundHandler=this.handleMessage.bind(this),window.addEventListener("message",this.boundHandler)}handleMessage(e){if(!this.allowedOrigins.some(t=>e.origin===t||"*"===t))return void(this.debug&&console.warn("[IDV SDK] Message from unauthorized origin:",e.origin));const t=e.data;if(!t?.type||"string"!=typeof t.type||!t.type.startsWith("IDV_"))return;if(t.nonce){if(this.processedNonces.has(t.nonce))return void(this.debug&&console.warn("[IDV SDK] Duplicate nonce detected, ignoring message"));if(this.processedNonces.add(t.nonce),this.processedNonces.size>100){const e=Array.from(this.processedNonces);this.processedNonces=new Set(e.slice(-50))}}this.debug&&console.log("[IDV SDK] Received message:",t.type,t.payload);(this.callbacks.get(t.type)||[]).forEach(e=>{try{e(t.payload)}catch(e){console.error("[IDV SDK] Error in message handler:",e)}})}on(e,t){const s=this.callbacks.get(e)||[];s.push(t),this.callbacks.set(e,s)}off(e,t){const s=this.callbacks.get(e)||[],i=s.indexOf(t);i>-1&&(s.splice(i,1),this.callbacks.set(e,s))}removeAllListeners(e){e?this.callbacks.delete(e):this.callbacks.clear()}destroy(){window.removeEventListener("message",this.boundHandler),this.callbacks.clear(),this.processedNonces.clear()}}class i{constructor(e){this.overlay=null,this.container=null,this.iframe=null,this.originalOverflow="",this.escHandler=null,this.config=e}open(){this.overlay||(this.createOverlay(),this.createContainer(),this.createIframe(),this.attachEventListeners(),this.preventScroll(),this.animateIn())}close(e="user_closed"){this.overlay&&this.animateOut(()=>{this.cleanup(),this.config.onClose?.(e)})}getIframe(){return this.iframe}isOpen(){return null!==this.overlay}createOverlay(){this.overlay=document.createElement("div"),this.overlay.id="idv-sdk-overlay",this.overlay.setAttribute("role","dialog"),this.overlay.setAttribute("aria-modal","true"),this.overlay.setAttribute("aria-label","Identity Verification"),Object.assign(this.overlay.style,{position:"fixed",top:"0",left:"0",right:"0",bottom:"0",backgroundColor:"rgba(0, 0, 0, 0.6)",zIndex:"2147483647",display:"flex",alignItems:"center",justifyContent:"center",opacity:"0",transition:"opacity 0.2s ease-out"}),document.body.appendChild(this.overlay)}isMobile(){return window.innerWidth<=480||/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)}createContainer(){const e=this.config.theme||{},t=this.isMobile();if(this.container=document.createElement("div"),this.container.id="idv-sdk-modal",t?Object.assign(this.container.style,{width:"100%",height:"100%",backgroundColor:e.backgroundColor||"#ffffff",borderRadius:"0",overflow:"hidden",position:"relative",transform:"translateY(20px)",transition:"transform 0.2s ease-out"}):Object.assign(this.container.style,{width:"100%",maxWidth:"800px",height:"90vh",maxHeight:"900px",backgroundColor:e.backgroundColor||"#ffffff",borderRadius:e.borderRadius||"16px",overflow:"hidden",position:"relative",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)",transform:"scale(0.95) translateY(10px)",transition:"transform 0.2s ease-out"}),!1!==this.config.modal?.showCloseButton){const e=this.createCloseButton();this.container.appendChild(e)}this.overlay.appendChild(this.container)}createCloseButton(){const e=document.createElement("button");return e.id="idv-sdk-close",e.setAttribute("aria-label","Close verification"),e.innerHTML="&#10005;",e.style.fontSize="16px",e.style.fontWeight="bold",Object.assign(e.style,{position:"absolute",top:"12px",right:"12px",width:"30px",height:"30px",borderRadius:"50%",border:"none",backgroundColor:"rgba(0, 0, 0, 0.08)",color:"#666666",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",zIndex:"10",transition:"background-color 0.15s ease"}),e.addEventListener("mouseenter",()=>{e.style.backgroundColor="rgba(0, 0, 0, 0.12)"}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="rgba(0, 0, 0, 0.08)"}),e.addEventListener("click",()=>{this.close("user_closed")}),e}createIframe(){this.iframe=document.createElement("iframe"),this.iframe.id="idv-sdk-iframe",this.iframe.src=this.config.iframeSrc,this.iframe.setAttribute("allow","camera; microphone; fullscreen"),this.iframe.setAttribute("scrolling","yes"),this.iframe.setAttribute("frameborder","0"),Object.assign(this.iframe.style,{width:"100%",height:"100%",border:"none",display:"block",backgroundColor:"#ffffff",WebkitOverflowScrolling:"touch",overflowY:"auto"}),this.container.appendChild(this.iframe)}attachEventListeners(){!1!==this.config.modal?.closeOnEscape&&(this.escHandler=e=>{"Escape"===e.key&&this.close("user_closed")},document.addEventListener("keydown",this.escHandler)),this.config.modal?.closeOnOverlayClick&&this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.close("user_closed")})}preventScroll(){!1!==this.config.modal?.preventScroll&&(this.originalOverflow=document.body.style.overflow,document.body.style.overflow="hidden",this.isMobile()&&(document.body.style.position="fixed",document.body.style.width="100%",document.body.style.height="100%"))}restoreScroll(){!1!==this.config.modal?.preventScroll&&(document.body.style.overflow=this.originalOverflow,this.isMobile()&&(document.body.style.position="",document.body.style.width="",document.body.style.height=""))}animateIn(){const e=this.isMobile();this.overlay.offsetHeight,requestAnimationFrame(()=>{this.overlay&&(this.overlay.style.opacity="1"),this.container&&(this.container.style.transform=e?"translateY(0)":"scale(1) translateY(0)")})}animateOut(e){const t=this.isMobile();this.overlay&&(this.overlay.style.opacity="0"),this.container&&(this.container.style.transform=t?"translateY(20px)":"scale(0.95) translateY(10px)"),setTimeout(e,200)}cleanup(){this.escHandler&&(document.removeEventListener("keydown",this.escHandler),this.escHandler=null),this.overlay&&(this.overlay.remove(),this.overlay=null),this.container=null,this.iframe=null,this.restoreScroll()}}const o="1.0.23.1";class n{constructor(){this.config=null,this.modalManager=null,this.messageBus=null,this.currentOptions=null,this.startTime=0}init(e){if(!e.apiKey)throw new Error("API key is required");this.config={environment:"production",debug:!1,...e},this.config.debug&&console.log("[IDV SDK] Initialized with config:",{environment:this.config.environment,apiKey:this.config.apiKey.substring(0,10)+"..."})}start(e={}){return new Promise((o,n)=>{if(!this.config){const s={code:t.NOT_INITIALIZED,message:"SDK not initialized. Call IDV.init() first ",recoverable:!1};return e.onError?.(s),void n(s)}if(this.modalManager?.isOpen()){const s={code:t.ALREADY_OPEN,message:"Verification already in progress",recoverable:!1};return e.onError?.(s),void n(s)}this.currentOptions=e,this.startTime=Date.now();const r=this.buildIframeUrl(e),a=this.getVerifyOrigin(),l=new URL(r).origin,c=a===l?[a]:[a,l];this.messageBus=new s(c,this.config.debug),this.setupMessageHandlers(o,n),this.modalManager=new i({iframeSrc:r,theme:e.theme,modal:e.modal,onClose:e=>{this.handleClose(e,n)}}),this.modalManager.open(),this.config.debug&&console.log("[IDV SDK] Modal opened with URL:",r)})}close(){this.modalManager?.isOpen()&&this.modalManager.close("user_closed")}getVersion(){return o}isInitialized(){return null!==this.config}isOpen(){return this.modalManager?.isOpen()??!1}buildIframeUrl(e){const t=this.config.baseUrl||this.getDefaultBaseUrl(),s=new URLSearchParams({"api-key":this.config.apiKey,"sdk-version":o,origin:window.location.origin});return e.user?.id&&s.set("user-id",e.user.id),e.user?.email&&s.set("user-email",e.user.email),e.user?.name&&s.set("user-name",e.user.name),e.country&&s.set("country",e.country),e.locale&&s.set("locale",e.locale),e.allowedDocumentTypes?.length&&s.set("doc-types",e.allowedDocumentTypes.join(",")),e.theme&&Object.keys(e.theme).length>0&&s.set("theme",btoa(JSON.stringify(e.theme))),`${t}/verify?${s.toString()}`}getDefaultBaseUrl(){return console.info("[############### IDV SDK] ",this.config.environment),console.info("[IDV baseUrl] ",this.config?.baseUrl),"sandbox"===this.config.environment?"https://sdk-test.trustcredo.com":"https://sdk.trustcredo.com"}getVerifyOrigin(){return this.config.baseUrl?new URL(this.config.baseUrl).origin:this.getDefaultBaseUrl()}setupMessageHandlers(e,t){this.messageBus&&(this.messageBus.on("IDV_READY",()=>{this.currentOptions?.onReady?.()}),this.messageBus.on("IDV_START",()=>{this.currentOptions?.onStart?.()}),this.messageBus.on("IDV_STEP",e=>{this.currentOptions?.onStep?.(e)}),this.messageBus.on("IDV_COMPLETE",t=>{const s=t;s.duration=Date.now()-this.startTime,this.currentOptions?.onComplete?.(s),this.modalManager?.close("completed"),this.cleanup(),e(s)}),this.messageBus.on("IDV_ERROR",e=>{const s=e;this.currentOptions?.onError?.(s),s.recoverable||(this.modalManager?.close("error"),this.cleanup(),t(s))}),this.messageBus.on("IDV_CLOSE",e=>{const t=e.reason||"user_closed";this.modalManager?.close(t)}))}handleClose(e,t){if(this.currentOptions?.onClose?.(e),"user_closed"===e){t({code:"USER_CANCELLED",message:"Verification was cancelled by the user",recoverable:!0})}this.cleanup()}cleanup(){this.messageBus?.destroy(),this.messageBus=null,this.modalManager=null,this.currentOptions=null}}const r=new n;e.ErrorCodes=t,e.IDV=r,e.IDVCore=n,e.default=r,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=idv.min.js.map
