{"version":3,"file":"idv.min.js","sources":["../src/types.ts","../src/MessageBus.ts","../src/ModalManager.ts","../src/IDV.ts"],"sourcesContent":["/**\r\n * IDV SDK Configuration\r\n */\r\nexport interface IDVConfig {\r\n  /** Partner API key (required) */\r\n  apiKey: string;\r\n  /** Environment: 'sandbox' or 'production' (default: 'production') */\r\n  environment?: 'sandbox' | 'production';\r\n  /** Override the verification app base URL */\r\n  baseUrl?: string;\r\n  /** Enable debug logging */\r\n  debug?: boolean;\r\n}\r\n\r\n/**\r\n * User context passed to verification\r\n */\r\nexport interface UserContext {\r\n  /** Partner's internal user ID */\r\n  id?: string;\r\n  /** User's email address */\r\n  email?: string;\r\n  /** User's full name */\r\n  name?: string;\r\n}\r\n\r\n/**\r\n * Theme customization options\r\n */\r\nexport interface ThemeOptions {\r\n  /** Primary button/accent color (hex) */\r\n  primaryColor?: string;\r\n  /** Modal background color */\r\n  backgroundColor?: string;\r\n  /** Primary text color */\r\n  textColor?: string;\r\n  /** Font family */\r\n  fontFamily?: string;\r\n  /** Border radius for buttons/cards */\r\n  borderRadius?: string;\r\n  /** Partner logo URL */\r\n  logoUrl?: string;\r\n}\r\n\r\n/**\r\n * Modal behavior options\r\n */\r\nexport interface ModalOptions {\r\n  /** Close modal when clicking overlay (default: false) */\r\n  closeOnOverlayClick?: boolean;\r\n  /** Close modal when pressing ESC (default: true) */\r\n  closeOnEscape?: boolean;\r\n  /** Show close button (default: true) */\r\n  showCloseButton?: boolean;\r\n  /** Prevent body scroll when modal open (default: true) */\r\n  preventScroll?: boolean;\r\n}\r\n\r\n/**\r\n * Options for starting verification\r\n */\r\nexport interface IDVStartOptions {\r\n  /** User context */\r\n  user?: UserContext;\r\n  /** Allowed document types */\r\n  allowedDocumentTypes?: ('passport' | 'drivers_license' | 'id_card')[];\r\n  /** Pre-selected country */\r\n  country?: string;\r\n  /** UI locale (e.g., 'en', 'es', 'fr') */\r\n  locale?: string;\r\n  /** Theme customization */\r\n  theme?: ThemeOptions;\r\n  /** Modal behavior */\r\n  modal?: ModalOptions;\r\n  /** Called when iframe is ready */\r\n  onReady?: () => void;\r\n  /** Called when user starts verification */\r\n  onStart?: () => void;\r\n  /** Called on step progression */\r\n  onStep?: (step: StepInfo) => void;\r\n  /** Called when verification completes */\r\n  onComplete?: (result: VerificationComplete) => void;\r\n  /** Called on error */\r\n  onError?: (error: SDKError) => void;\r\n  /** Called when modal closes */\r\n  onClose?: (reason: CloseReason) => void;\r\n}\r\n\r\n/**\r\n * Step progression info\r\n */\r\nexport interface StepInfo {\r\n  /** Current step name */\r\n  step: 'intro' | 'document_select' | 'document_capture' | 'document_review' |\r\n        'selfie_intro' | 'selfie_capture' | 'selfie_review' | 'processing' | 'complete';\r\n  /** Step number (1-8) */\r\n  stepNumber: number;\r\n  /** Total steps */\r\n  totalSteps: number;\r\n  /** Timestamp */\r\n  timestamp: string;\r\n}\r\n\r\n/**\r\n * Verification result passed to onComplete\r\n */\r\nexport interface VerificationComplete {\r\n  /** Unique verification ID */\r\n  verificationId: string;\r\n  /** Verification status */\r\n  status: 'passed' | 'failed' | 'review';\r\n  /** Result summary */\r\n  result: {\r\n    passed: boolean;\r\n    riskLevel: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';\r\n    message?: string;\r\n  };\r\n  /** Extracted data (if passed and permitted) */\r\n  extractedData?: {\r\n    fullName?: string;\r\n    dateOfBirth?: string;\r\n    documentNumber?: string;\r\n    expiryDate?: string;\r\n    issuingCountry?: string;\r\n  };\r\n  /** Completion timestamp */\r\n  completedAt: string;\r\n  /** Duration in milliseconds */\r\n  duration: number;\r\n}\r\n\r\n/**\r\n * SDK error\r\n */\r\nexport interface SDKError {\r\n  /** Error code */\r\n  code: string;\r\n  /** Human-readable message */\r\n  message: string;\r\n  /** Additional details */\r\n  details?: Record<string, unknown>;\r\n  /** Whether the error is recoverable */\r\n  recoverable: boolean;\r\n}\r\n\r\n/**\r\n * Reason for modal close\r\n */\r\nexport type CloseReason = 'user_closed' | 'completed' | 'error' | 'expired';\r\n\r\n/**\r\n * Message types for postMessage communication\r\n */\r\nexport type MessageType =\r\n  | 'IDV_READY'\r\n  | 'IDV_START'\r\n  | 'IDV_STEP'\r\n  | 'IDV_COMPLETE'\r\n  | 'IDV_ERROR'\r\n  | 'IDV_CLOSE';\r\n\r\n/**\r\n * Message structure for postMessage\r\n */\r\nexport interface SDKMessage<T = unknown> {\r\n  type: MessageType;\r\n  payload: T;\r\n  timestamp: string;\r\n  nonce: string;\r\n}\r\n\r\n/**\r\n * Error codes\r\n */\r\nexport const ErrorCodes = {\r\n  // Initialization\r\n  INVALID_API_KEY: 'INVALID_API_KEY',\r\n  NOT_INITIALIZED: 'NOT_INITIALIZED',\r\n  ALREADY_OPEN: 'ALREADY_OPEN',\r\n\r\n  // Browser\r\n  BROWSER_NOT_SUPPORTED: 'BROWSER_NOT_SUPPORTED',\r\n  CAMERA_PERMISSION_DENIED: 'CAMERA_PERMISSION_DENIED',\r\n  CAMERA_NOT_FOUND: 'CAMERA_NOT_FOUND',\r\n\r\n  // Verification\r\n  VERIFICATION_FAILED: 'VERIFICATION_FAILED',\r\n  DOCUMENT_UNREADABLE: 'DOCUMENT_UNREADABLE',\r\n  FACE_NOT_DETECTED: 'FACE_NOT_DETECTED',\r\n\r\n  // Network\r\n  NETWORK_ERROR: 'NETWORK_ERROR',\r\n  TIMEOUT: 'TIMEOUT',\r\n\r\n  // Session\r\n  SESSION_EXPIRED: 'SESSION_EXPIRED',\r\n} as const;\r\n","import type { MessageType, SDKMessage } from './types';\r\n\r\ntype MessageCallback = (payload: unknown) => void;\r\n\r\n/**\r\n * Handles postMessage communication between parent page and iframe\r\n */\r\nexport class MessageBus {\r\n  private allowedOrigins: string[];\r\n  private callbacks: Map<MessageType, MessageCallback[]> = new Map();\r\n  private processedNonces: Set<string> = new Set();\r\n  private debug: boolean;\r\n  private boundHandler: (event: MessageEvent) => void;\r\n\r\n  constructor(allowedOrigins: string[], debug = false) {\r\n    this.allowedOrigins = allowedOrigins;\r\n    this.debug = debug;\r\n    this.boundHandler = this.handleMessage.bind(this);\r\n    window.addEventListener('message', this.boundHandler);\r\n  }\r\n\r\n  /**\r\n   * Handle incoming postMessage events\r\n   */\r\n  private handleMessage(event: MessageEvent): void {\r\n    // Validate origin\r\n    if (!this.allowedOrigins.some(origin => event.origin === origin || origin === '*')) {\r\n      if (this.debug) {\r\n        console.warn('[IDV SDK] Message from unauthorized origin:', event.origin);\r\n      }\r\n      return;\r\n    }\r\n\r\n    // Validate message structure\r\n    const message = event.data as SDKMessage;\r\n    if (!message?.type || typeof message.type !== 'string' || !message.type.startsWith('IDV_')) {\r\n      return;\r\n    }\r\n\r\n    // Prevent replay attacks (skip if no nonce - older messages)\r\n    if (message.nonce) {\r\n      if (this.processedNonces.has(message.nonce)) {\r\n        if (this.debug) {\r\n          console.warn('[IDV SDK] Duplicate nonce detected, ignoring message');\r\n        }\r\n        return;\r\n      }\r\n      this.processedNonces.add(message.nonce);\r\n\r\n      // Clean up old nonces periodically (keep last 100)\r\n      if (this.processedNonces.size > 100) {\r\n        const noncesArray = Array.from(this.processedNonces);\r\n        this.processedNonces = new Set(noncesArray.slice(-50));\r\n      }\r\n    }\r\n\r\n    if (this.debug) {\r\n      console.log('[IDV SDK] Received message:', message.type, message.payload);\r\n    }\r\n\r\n    // Dispatch to registered callbacks\r\n    const handlers = this.callbacks.get(message.type as MessageType) || [];\r\n    handlers.forEach(callback => {\r\n      try {\r\n        callback(message.payload);\r\n      } catch (error) {\r\n        console.error('[IDV SDK] Error in message handler:', error);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Register a callback for a message type\r\n   */\r\n  on(type: MessageType, callback: MessageCallback): void {\r\n    const handlers = this.callbacks.get(type) || [];\r\n    handlers.push(callback);\r\n    this.callbacks.set(type, handlers);\r\n  }\r\n\r\n  /**\r\n   * Unregister a callback\r\n   */\r\n  off(type: MessageType, callback: MessageCallback): void {\r\n    const handlers = this.callbacks.get(type) || [];\r\n    const index = handlers.indexOf(callback);\r\n    if (index > -1) {\r\n      handlers.splice(index, 1);\r\n      this.callbacks.set(type, handlers);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all callbacks for a message type\r\n   */\r\n  removeAllListeners(type?: MessageType): void {\r\n    if (type) {\r\n      this.callbacks.delete(type);\r\n    } else {\r\n      this.callbacks.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clean up and remove event listener\r\n   */\r\n  destroy(): void {\r\n    window.removeEventListener('message', this.boundHandler);\r\n    this.callbacks.clear();\r\n    this.processedNonces.clear();\r\n  }\r\n}\r\n","import type { ModalOptions, ThemeOptions, CloseReason } from './types';\r\n\r\nexport interface ModalConfig {\r\n  iframeSrc: string;\r\n  theme?: ThemeOptions;\r\n  modal?: ModalOptions;\r\n  onClose?: (reason: CloseReason) => void;\r\n}\r\n\r\n/**\r\n * Manages the modal overlay and iframe\r\n */\r\nexport class ModalManager {\r\n  private overlay: HTMLDivElement | null = null;\r\n  private container: HTMLDivElement | null = null;\r\n  private iframe: HTMLIFrameElement | null = null;\r\n  private config: ModalConfig;\r\n  private originalOverflow: string = '';\r\n  private escHandler: ((e: KeyboardEvent) => void) | null = null;\r\n\r\n  constructor(config: ModalConfig) {\r\n    this.config = config;\r\n  }\r\n\r\n  /**\r\n   * Open the modal with iframe\r\n   */\r\n  open(): void {\r\n    if (this.overlay) {\r\n      return; // Already open\r\n    }\r\n\r\n    this.createOverlay();\r\n    this.createContainer();\r\n    this.createIframe();\r\n    this.attachEventListeners();\r\n    this.preventScroll();\r\n    this.animateIn();\r\n  }\r\n\r\n  /**\r\n   * Close the modal\r\n   */\r\n  close(reason: CloseReason = 'user_closed'): void {\r\n    if (!this.overlay) {\r\n      return;\r\n    }\r\n\r\n    this.animateOut(() => {\r\n      this.cleanup();\r\n      this.config.onClose?.(reason);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the iframe element\r\n   */\r\n  getIframe(): HTMLIFrameElement | null {\r\n    return this.iframe;\r\n  }\r\n\r\n  /**\r\n   * Check if modal is open\r\n   */\r\n  isOpen(): boolean {\r\n    return this.overlay !== null;\r\n  }\r\n\r\n  private createOverlay(): void {\r\n    this.overlay = document.createElement('div');\r\n    this.overlay.id = 'idv-sdk-overlay';\r\n    this.overlay.setAttribute('role', 'dialog');\r\n    this.overlay.setAttribute('aria-modal', 'true');\r\n    this.overlay.setAttribute('aria-label', 'Identity Verification');\r\n\r\n    Object.assign(this.overlay.style, {\r\n      position: 'fixed',\r\n      top: '0',\r\n      left: '0',\r\n      right: '0',\r\n      bottom: '0',\r\n      backgroundColor: 'rgba(0, 0, 0, 0.6)',\r\n      zIndex: '2147483647',\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      justifyContent: 'center',\r\n      opacity: '0',\r\n      transition: 'opacity 0.2s ease-out',\r\n    });\r\n\r\n    document.body.appendChild(this.overlay);\r\n  }\r\n\r\n  private createContainer(): void {\r\n    const theme = this.config.theme || {};\r\n\r\n    this.container = document.createElement('div');\r\n    this.container.id = 'idv-sdk-modal';\r\n\r\n    Object.assign(this.container.style, {\r\n      width: '100%',\r\n      maxWidth: '420px',\r\n      height: '90vh',\r\n      maxHeight: '720px',\r\n      backgroundColor: theme.backgroundColor || '#ffffff',\r\n      borderRadius: theme.borderRadius || '16px',\r\n      overflow: 'hidden',\r\n      position: 'relative',\r\n      boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)',\r\n      transform: 'scale(0.95) translateY(10px)',\r\n      transition: 'transform 0.2s ease-out',\r\n    });\r\n\r\n    // Add close button if enabled\r\n    if (this.config.modal?.showCloseButton !== false) {\r\n      const closeButton = this.createCloseButton();\r\n      this.container.appendChild(closeButton);\r\n    }\r\n\r\n    this.overlay!.appendChild(this.container);\r\n  }\r\n\r\n  private createCloseButton(): HTMLButtonElement {\r\n    const button = document.createElement('button');\r\n    button.id = 'idv-sdk-close';\r\n    button.setAttribute('aria-label', 'Close verification');\r\n    button.innerHTML = `\r\n      <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\r\n        <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\"></line>\r\n        <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\"></line>\r\n      </svg>\r\n    `;\r\n\r\n    Object.assign(button.style, {\r\n      position: 'absolute',\r\n      top: '12px',\r\n      right: '12px',\r\n      width: '36px',\r\n      height: '36px',\r\n      borderRadius: '50%',\r\n      border: 'none',\r\n      backgroundColor: 'rgba(0, 0, 0, 0.08)',\r\n      color: '#666666',\r\n      cursor: 'pointer',\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      justifyContent: 'center',\r\n      zIndex: '10',\r\n      transition: 'background-color 0.15s ease',\r\n    });\r\n\r\n    button.addEventListener('mouseenter', () => {\r\n      button.style.backgroundColor = 'rgba(0, 0, 0, 0.12)';\r\n    });\r\n\r\n    button.addEventListener('mouseleave', () => {\r\n      button.style.backgroundColor = 'rgba(0, 0, 0, 0.08)';\r\n    });\r\n\r\n    button.addEventListener('click', () => {\r\n      this.close('user_closed');\r\n    });\r\n\r\n    return button;\r\n  }\r\n\r\n  private createIframe(): void {\r\n    this.iframe = document.createElement('iframe');\r\n    this.iframe.id = 'idv-sdk-iframe';\r\n    this.iframe.src = this.config.iframeSrc;\r\n    this.iframe.setAttribute('allow', 'camera; microphone');\r\n    this.iframe.setAttribute('allowfullscreen', 'true');\r\n\r\n    Object.assign(this.iframe.style, {\r\n      width: '100%',\r\n      height: '100%',\r\n      border: 'none',\r\n      display: 'block',\r\n    });\r\n\r\n    this.container!.appendChild(this.iframe);\r\n  }\r\n\r\n  private attachEventListeners(): void {\r\n    // ESC key handler\r\n    if (this.config.modal?.closeOnEscape !== false) {\r\n      this.escHandler = (e: KeyboardEvent) => {\r\n        if (e.key === 'Escape') {\r\n          this.close('user_closed');\r\n        }\r\n      };\r\n      document.addEventListener('keydown', this.escHandler);\r\n    }\r\n\r\n    // Overlay click handler\r\n    if (this.config.modal?.closeOnOverlayClick) {\r\n      this.overlay!.addEventListener('click', (e: MouseEvent) => {\r\n        if (e.target === this.overlay) {\r\n          this.close('user_closed');\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private preventScroll(): void {\r\n    if (this.config.modal?.preventScroll !== false) {\r\n      this.originalOverflow = document.body.style.overflow;\r\n      document.body.style.overflow = 'hidden';\r\n    }\r\n  }\r\n\r\n  private restoreScroll(): void {\r\n    if (this.config.modal?.preventScroll !== false) {\r\n      document.body.style.overflow = this.originalOverflow;\r\n    }\r\n  }\r\n\r\n  private animateIn(): void {\r\n    // Force reflow\r\n    this.overlay!.offsetHeight;\r\n\r\n    requestAnimationFrame(() => {\r\n      if (this.overlay) {\r\n        this.overlay.style.opacity = '1';\r\n      }\r\n      if (this.container) {\r\n        this.container.style.transform = 'scale(1) translateY(0)';\r\n      }\r\n    });\r\n  }\r\n\r\n  private animateOut(callback: () => void): void {\r\n    if (this.overlay) {\r\n      this.overlay.style.opacity = '0';\r\n    }\r\n    if (this.container) {\r\n      this.container.style.transform = 'scale(0.95) translateY(10px)';\r\n    }\r\n\r\n    setTimeout(callback, 200);\r\n  }\r\n\r\n  private cleanup(): void {\r\n    // Remove ESC handler\r\n    if (this.escHandler) {\r\n      document.removeEventListener('keydown', this.escHandler);\r\n      this.escHandler = null;\r\n    }\r\n\r\n    // Remove overlay from DOM\r\n    if (this.overlay) {\r\n      this.overlay.remove();\r\n      this.overlay = null;\r\n    }\r\n\r\n    this.container = null;\r\n    this.iframe = null;\r\n    this.restoreScroll();\r\n  }\r\n}\r\n","import type {\r\n  IDVConfig,\r\n  IDVStartOptions,\r\n  VerificationComplete,\r\n  SDKError,\r\n  StepInfo,\r\n  CloseReason,\r\n} from './types';\r\nimport { ErrorCodes } from './types';\r\nimport { MessageBus } from './MessageBus';\r\nimport { ModalManager } from './ModalManager';\r\n\r\nconst SDK_VERSION = '1.0.0';\r\n\r\n/**\r\n * Main IDV SDK class\r\n */\r\nexport class IDVCore {\r\n  private config: IDVConfig | null = null;\r\n  private modalManager: ModalManager | null = null;\r\n  private messageBus: MessageBus | null = null;\r\n  private currentOptions: IDVStartOptions | null = null;\r\n  private startTime: number = 0;\r\n\r\n  /**\r\n   * Initialize the SDK with configuration\r\n   */\r\n  init(config: IDVConfig): void {\r\n    if (!config.apiKey) {\r\n      throw new Error('API key is required');\r\n    }\r\n\r\n    // Validate API key format (basic check)\r\n    if (!config.apiKey.startsWith('pk_')) {\r\n      console.warn('[IDV SDK] API key should start with \"pk_\" for public keys');\r\n    }\r\n\r\n    this.config = {\r\n      environment: 'production',\r\n      debug: false,\r\n      ...config,\r\n    };\r\n\r\n    if (this.config.debug) {\r\n      console.log('[IDV SDK] Initialized with config:', {\r\n        environment: this.config.environment,\r\n        apiKey: this.config.apiKey.substring(0, 10) + '...',\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start the verification flow\r\n   */\r\n  start(options: IDVStartOptions = {}): Promise<VerificationComplete> {\r\n    return new Promise((resolve, reject) => {\r\n      if (!this.config) {\r\n        const error: SDKError = {\r\n          code: ErrorCodes.NOT_INITIALIZED,\r\n          message: 'SDK not initialized. Call IDV.init() first.',\r\n          recoverable: false,\r\n        };\r\n        options.onError?.(error);\r\n        reject(error);\r\n        return;\r\n      }\r\n\r\n      if (this.modalManager?.isOpen()) {\r\n        const error: SDKError = {\r\n          code: ErrorCodes.ALREADY_OPEN,\r\n          message: 'Verification already in progress',\r\n          recoverable: false,\r\n        };\r\n        options.onError?.(error);\r\n        reject(error);\r\n        return;\r\n      }\r\n\r\n      this.currentOptions = options;\r\n      this.startTime = Date.now();\r\n\r\n      // Build iframe URL\r\n      const iframeSrc = this.buildIframeUrl(options);\r\n\r\n      // Set up message bus\r\n      const verifyOrigin = this.getVerifyOrigin();\r\n      this.messageBus = new MessageBus([verifyOrigin], this.config.debug);\r\n      this.setupMessageHandlers(resolve, reject);\r\n\r\n      // Create and open modal\r\n      this.modalManager = new ModalManager({\r\n        iframeSrc,\r\n        theme: options.theme,\r\n        modal: options.modal,\r\n        onClose: (reason: CloseReason) => {\r\n          this.handleClose(reason, reject);\r\n        },\r\n      });\r\n\r\n      this.modalManager.open();\r\n\r\n      if (this.config.debug) {\r\n        console.log('[IDV SDK] Modal opened with URL:', iframeSrc);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Close the verification modal\r\n   */\r\n  close(): void {\r\n    if (this.modalManager?.isOpen()) {\r\n      this.modalManager.close('user_closed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get SDK version\r\n   */\r\n  getVersion(): string {\r\n    return SDK_VERSION;\r\n  }\r\n\r\n  /**\r\n   * Check if SDK is initialized\r\n   */\r\n  isInitialized(): boolean {\r\n    return this.config !== null;\r\n  }\r\n\r\n  /**\r\n   * Check if verification is in progress\r\n   */\r\n  isOpen(): boolean {\r\n    return this.modalManager?.isOpen() ?? false;\r\n  }\r\n\r\n  private buildIframeUrl(options: IDVStartOptions): string {\r\n    const baseUrl = this.config!.baseUrl || this.getDefaultBaseUrl();\r\n\r\n    const params = new URLSearchParams({\r\n      'api-key': this.config!.apiKey,\r\n      'sdk-version': SDK_VERSION,\r\n      'origin': window.location.origin,\r\n    });\r\n\r\n    // Add user context\r\n    if (options.user?.id) params.set('user-id', options.user.id);\r\n    if (options.user?.email) params.set('user-email', options.user.email);\r\n    if (options.user?.name) params.set('user-name', options.user.name);\r\n\r\n    // Add verification options\r\n    if (options.country) params.set('country', options.country);\r\n    if (options.locale) params.set('locale', options.locale);\r\n    if (options.allowedDocumentTypes?.length) {\r\n      params.set('doc-types', options.allowedDocumentTypes.join(','));\r\n    }\r\n\r\n    // Add theme as base64 encoded JSON\r\n    if (options.theme && Object.keys(options.theme).length > 0) {\r\n      params.set('theme', btoa(JSON.stringify(options.theme)));\r\n    }\r\n\r\n    return `${baseUrl}/verify?${params.toString()}`;\r\n  }\r\n\r\n  private getDefaultBaseUrl(): string {\r\n    if (this.config!.environment === 'sandbox') {\r\n      return 'https://verify.sandbox.trustcredo.com';\r\n    }\r\n    return 'https://verify.trustcredo.com';\r\n  }\r\n\r\n  private getVerifyOrigin(): string {\r\n    if (this.config!.baseUrl) {\r\n      return new URL(this.config!.baseUrl).origin;\r\n    }\r\n    return this.getDefaultBaseUrl();\r\n  }\r\n\r\n  private setupMessageHandlers(\r\n    resolve: (result: VerificationComplete) => void,\r\n    reject: (error: SDKError) => void\r\n  ): void {\r\n    if (!this.messageBus) return;\r\n\r\n    // Ready event\r\n    this.messageBus.on('IDV_READY', () => {\r\n      this.currentOptions?.onReady?.();\r\n    });\r\n\r\n    // Start event\r\n    this.messageBus.on('IDV_START', () => {\r\n      this.currentOptions?.onStart?.();\r\n    });\r\n\r\n    // Step event\r\n    this.messageBus.on('IDV_STEP', (payload) => {\r\n      this.currentOptions?.onStep?.(payload as StepInfo);\r\n    });\r\n\r\n    // Complete event\r\n    this.messageBus.on('IDV_COMPLETE', (payload) => {\r\n      const result = payload as VerificationComplete;\r\n      result.duration = Date.now() - this.startTime;\r\n\r\n      this.currentOptions?.onComplete?.(result);\r\n      this.modalManager?.close('completed');\r\n      this.cleanup();\r\n      resolve(result);\r\n    });\r\n\r\n    // Error event\r\n    this.messageBus.on('IDV_ERROR', (payload) => {\r\n      const error = payload as SDKError;\r\n      this.currentOptions?.onError?.(error);\r\n\r\n      if (!error.recoverable) {\r\n        this.modalManager?.close('error');\r\n        this.cleanup();\r\n        reject(error);\r\n      }\r\n    });\r\n\r\n    // Close event (from iframe)\r\n    this.messageBus.on('IDV_CLOSE', (payload) => {\r\n      const reason = (payload as { reason: CloseReason }).reason || 'user_closed';\r\n      this.modalManager?.close(reason);\r\n    });\r\n  }\r\n\r\n  private handleClose(reason: CloseReason, reject: (error: SDKError) => void): void {\r\n    this.currentOptions?.onClose?.(reason);\r\n\r\n    if (reason === 'user_closed') {\r\n      // User cancelled - reject with cancellation error\r\n      const error: SDKError = {\r\n        code: 'USER_CANCELLED',\r\n        message: 'Verification was cancelled by the user',\r\n        recoverable: true,\r\n      };\r\n      reject(error);\r\n    }\r\n\r\n    this.cleanup();\r\n  }\r\n\r\n  private cleanup(): void {\r\n    this.messageBus?.destroy();\r\n    this.messageBus = null;\r\n    this.modalManager = null;\r\n    this.currentOptions = null;\r\n  }\r\n}\r\n\r\n// Create singleton instance\r\nexport const IDV = new IDVCore();\r\n"],"names":["ErrorCodes","INVALID_API_KEY","NOT_INITIALIZED","ALREADY_OPEN","BROWSER_NOT_SUPPORTED","CAMERA_PERMISSION_DENIED","CAMERA_NOT_FOUND","VERIFICATION_FAILED","DOCUMENT_UNREADABLE","FACE_NOT_DETECTED","NETWORK_ERROR","TIMEOUT","SESSION_EXPIRED","MessageBus","constructor","allowedOrigins","debug","this","callbacks","Map","processedNonces","Set","boundHandler","handleMessage","bind","window","addEventListener","event","some","origin","console","warn","message","data","type","startsWith","nonce","has","add","size","noncesArray","Array","from","slice","log","payload","get","forEach","callback","error","on","handlers","push","set","off","index","indexOf","splice","removeAllListeners","delete","clear","destroy","removeEventListener","ModalManager","config","overlay","container","iframe","originalOverflow","escHandler","open","createOverlay","createContainer","createIframe","attachEventListeners","preventScroll","animateIn","close","reason","animateOut","cleanup","onClose","getIframe","isOpen","document","createElement","id","setAttribute","Object","assign","style","position","top","left","right","bottom","backgroundColor","zIndex","display","alignItems","justifyContent","opacity","transition","body","appendChild","theme","width","maxWidth","height","maxHeight","borderRadius","overflow","boxShadow","transform","modal","showCloseButton","closeButton","createCloseButton","button","innerHTML","border","color","cursor","src","iframeSrc","closeOnEscape","e","key","closeOnOverlayClick","target","restoreScroll","offsetHeight","requestAnimationFrame","setTimeout","remove","SDK_VERSION","IDVCore","modalManager","messageBus","currentOptions","startTime","init","apiKey","Error","environment","substring","start","options","Promise","resolve","reject","code","recoverable","onError","Date","now","buildIframeUrl","verifyOrigin","getVerifyOrigin","setupMessageHandlers","handleClose","getVersion","isInitialized","baseUrl","getDefaultBaseUrl","params","URLSearchParams","location","user","email","name","country","locale","allowedDocumentTypes","length","join","keys","btoa","JSON","stringify","toString","URL","onReady","onStart","onStep","result","duration","onComplete","IDV"],"mappings":"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"}